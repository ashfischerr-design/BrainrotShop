<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainrot Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #8B0000; color: white; }
        .card { background-color: #A52A2A; border: 2px solid #FF0000; margin: 10px; }
        .card:hover { transform: scale(1.05); transition: 0.3s; }
        .btn-red { background-color: #FF0000; border-color: #FF0000; color: white; }
        .btn-red:hover { background-color: #CC0000; border-color: #CC0000; }
        .modal-content { background-color: #8B0000; color: white; }
        .header { background-color: #A52A2A; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-page">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <h1 class="text-center"><i class="fas fa-sign-in-alt"></i> Login</h1>
                    <input type="text" id="login-username" class="form-control mb-2" placeholder="Username">
                    <input type="password" id="login-password" class="form-control mb-2" placeholder="Password">
                    <button class="btn btn-red w-100" onclick="login()">Login</button>
                    <button class="btn btn-secondary w-100 mt-2" onclick="showSignup()">Signup</button>
                </div>
            </div>
        </div>
        <div id="signup-page" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <h1 class="text-center"><i class="fas fa-user-plus"></i> Signup</h1>
                    <input type="text" id="signup-username" class="form-control mb-2" placeholder="Username">
                    <input type="password" id="signup-password" class="form-control mb-2" placeholder="Password">
                    <button class="btn btn-red w-100" onclick="signup()">Signup</button>
                    <button class="btn btn-secondary w-100 mt-2" onclick="showLogin()">Back to Login</button>
                </div>
            </div>
        </div>
        <div id="shop-page" style="display: none;">
            <div class="header d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-store"></i> Brainrot Shop</h1>
                <div>
                    <button class="btn btn-red" id="messages-btn" onclick="showMessages()"><i class="fas fa-envelope"></i> Messages</button>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
            <div id="admin-controls" style="display: none;" class="mt-4">
                <h2><i class="fas fa-plus"></i> Add Brainrot</h2>
                <input type="text" id="item-name" class="form-control mb-2" placeholder="Name">
                <input type="number" id="item-price" class="form-control mb-2" placeholder="Price">
                <input type="file" id="item-image" class="form-control mb-2" accept="image/*">
                <button class="btn btn-red" onclick="addItem()">Add</button>
            </div>
            <div id="items-list" class="row mt-4"></div>
        </div>
        <div id="messages-page" style="display: none;">
            <h1><i class="fas fa-comments"></i> Messages</h1>
            <div id="messages-list"></div>
            <button class="btn btn-secondary mt-3" onclick="backToShop()">Back</button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="buyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Choose Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-red w-100 mb-2" onclick="selectPayment('crypto')">Crypto</button>
                    <button class="btn btn-red w-100 mb-2" onclick="selectPayment('robux')">Robux</button>
                    <button class="btn btn-red w-100" onclick="selectPayment('giftcard')">Gift Card</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Message Ash</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="message-text" class="form-control" placeholder="Your message"></textarea>
                    <button class="btn btn-red mt-2" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000'; // Change to your deployed URL
        const socket = io(API_URL);
        let currentUser = null;
        let items = [];
        let messages = {};

        socket.on('updateItems', () => loadItems());
        socket.on('updateMessages', (user) => { if (currentUser === user || currentUser === 'ash') loadMessages(); });

        function showSignup() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('signup-page').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('signup-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'block';
        }

        async function signup() {
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            const res = await fetch(`${API_URL}/signup`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            if (res.ok) { alert('Signed up!'); showLogin(); } else alert('Username taken');
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const res = await fetch(`${API_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            if (res.ok) {
                currentUser = username;
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('shop-page').style.display = 'block';
                if (username === 'ash') document.getElementById('admin-controls').style.display = 'block';
                loadItems();
            } else alert('Invalid credentials');
        }

        function logout() {
            currentUser = null;
            document.getElementById('shop-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'block';
        }

        async function addItem() {
            if (currentUser !== 'ash') return;
            const name = document.getElementById('item-name').value;
            const price = document.getElementById('item-price').value;
            const file = document.getElementById('item-image').files[0];
            if (name && price && file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    await fetch(`${API_URL}/items`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, price, image: e.target.result }) });
                };
                reader.readAsDataURL(file);
            }
        }

        async function deleteItem(id) {
            if (currentUser !== 'ash') return;
            await fetch(`${API_URL}/items/${id}`, { method: 'DELETE' });
        }

        async function loadItems() {
            const res = await fetch(`${API_URL}/items`);
            items = await res.json();
            renderItems();
        }

        function renderItems() {
            const list = document.getElementById('items-list');
            list.innerHTML = '';
            items.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
                    <div class="card">
                        <img src="${item.image}" class="card-img-top" alt="${item.name}">
                        <div class="card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <p class="card-text">Price: $${item.price}</p>
                            <button class="btn btn-red" onclick="buyItem('${item._id}')">Buy</button>
                            ${currentUser === 'ash' ? `<button class="btn btn-danger mt-2" onclick="deleteItem('${item._id}')">Delete</button>` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(col);
            });
        }

        function buyItem(id) {
            document.getElementById('buyModal').dataset.itemId = id;
            new bootstrap.Modal(document.getElementById('buyModal')).show();
        }

        function selectPayment(type) {
            bootstrap.Modal.getInstance(document.getElementById('buyModal')).hide();
            document.getElementById('messageModal').dataset.itemId = document.getElementById('buyModal').dataset.itemId;
            document.getElementById('messageModal').dataset.payment = type;
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        }

        async function sendMessage() {
            const text = document.getElementById('message-text').value;
            const itemId = document.getElementById('messageModal').dataset.itemId;
            const payment = document.getElementById('messageModal').dataset.payment;
            if (text) {
                await fetch(`${API_URL}/messages`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ from: currentUser, to: 'ash', text, itemId, payment, timestamp: new Date() }) });
                alert('Message sent!');
                bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
            }
        }

        async function showMessages() {
            if (currentUser !== 'ash') return;
            document.getElementById('shop-page').style.display = 'none';
            document.getElementById('messages-page').style.display = 'block';
            await loadMessages();
        }

        async function loadMessages() {
            const res = await fetch(`${API_URL}/messages/${currentUser}`);
            messages = await res.json();
            renderMessages();
        }

        function renderMessages() {
            const list = document.getElementById('messages-list');
            list.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'card mb-2';
                div.innerHTML = `
                    <div class="card-body">
                        <p><strong>${msg.from}:</strong> ${msg.text} (Payment: ${msg.payment}, Item: ${msg.itemId})</p>
                        <textarea class="form-control" id="reply-${msg._id}" placeholder="Reply"></textarea>
                        <button class="btn btn-red mt-2" onclick="replyMessage('${msg._id}', '${msg.from}')